## 대역의 필요성

자동이체 기능을 예로 들어보자. 이 기능은 외부 업체가 제공하는 API를 이용해서 카드번호가 유효한지 확인하고 그 결과에 따라 자동이체 정보를 등록한다. 이 기능을 테스트하려면 정상 카드번호, 도난 카드번호, 만료일이 지난 카드번호가 필요하기 때문에 외부 업체에서 상황별로 테스트할 수 있는 카드번호를 받아와야 한다.

TDD는 “테스트 작성 → 통과시킬 만큼 구현 → 리팩터링”의 과정으로 진행한다.

> 자동이체 정보 등록 기능 → 카드 번호 검사기 → 카드 정보 검사 대행 업체(외부 시스템)의 카드 정보 검사 API
>

자동이체 정보 등록 기능을 테스트하는 코드는 외부 요인인 카드 정보 검사 대행업체의 상태에 따라 테스트를 할 수 없는 상황이 발생한다.

예를 들어 카드 정보 검사 대행업체에서 테스트할 때 사용하라고 제공한 카드번호의 유효 기간이 한 달 뒤일 수 있다. 이 카드번호를 사용해서 성공한 자동이체 정보 등록 기능 테스트는 한 달 뒤에 유효 기간 만료로 실패하게 된다.

자동이체 정보 등록 기능과 카드번호 검사기의 코드 구조가 다음과 같다.

> AutoDebitRegister → CardNumberValidator — API 호출 → 외부 카드 정보 API
>

`AutoDebitRegister` 클래스는 자동이체 등록 기능을 구현했고 `CardNumberValidator`는 외부 API를 이용해서 카드번호가 유효한지 확인한다. `AutoDebitRegister` 클래스는 `CardNumberValidator`를 이용해서 카드번호가 유효한지 검사한 뒤에 그 결과에 따라 자동이체 정보를 저장한다.

`AutoDebitRegister` 클래스에서 사용하는 `CardNumberValidator` 클래스는 아래와 같이 외부 서비스에서 제공하는 HTTP URL을 이용해 카드번호가 유효한지 검사하고 그 결과를 리턴한다. 참고로 이 코드는 예를 들기 위한 코드로 실제로 some-external-pg와 같은 서비스는 존재하지 않는다.

`AutoDebitRegister` 클래스를 테스트하는 코드를 작성한다.

`validCard()` 테스트를 통과시키려면 외부 업체에서 테스트 목적의 유효한 카드 번호를 받아야 한다. 만약 이 카드번호가 한 달 뒤에 만료되면 `validCard()` 테스트는 한 달 뒤부터 실패한다.

이렇게 테스트 대상에서 의존하는 요인 때문에 테스트가 어려울 때는 대역을 써서 테스트를 진행할 수 있다. → 액션을 배우가 하는게 아니라 스턴트맨이 하는 것과 같다.

>💡 Double : 영어로 된 테스트 관련 글을 읽으면 test double이란 표현이 자주 나오는데 여기서 double은 본 장에서 설명하는 대역에 해당한다. 즉, test double은 테스트에서 진짜 대신 사용할 대역을 의미한다.
대역의 종류는 스텁, 가짜, 스파이, 모의 객체가 존재하며 각 대역 종류마다 쓰임새가 다르다.
